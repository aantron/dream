module Message = Dream_pure.Message
module Stream = Dream_pure.Stream

let%expect_test "built-in middleware warns on empty headers in response \
                 messages" =
  let invalid_headers =
    [
      (" ", "");
      ("", "value-with-empty-key");
      ("content-type", "application/json");
      ("custom-key", "custom-value");
    ]
  in
  let handler _ = Dream.empty ~headers:invalid_headers `OK in
  let server =
    Dream__http.Http.built_in_middleware (fun _ -> Lwt.return None) @@ handler
  in
  ignore (Lwt_main.run (server (Dream.request "")));
  [%expect {|
  22.04.23 20:57:51.460      dream.http  WARN A response header is empty or contains only whitespace. This is not allowed by RFC 7230.
    |}]
